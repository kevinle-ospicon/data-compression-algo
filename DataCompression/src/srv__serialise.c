/*============================================================================
@brief A C source for log data serialisation service
------------------------------------------------------------------------------
<!-- Written by Kevin (Phuc) Le Dinh -->
<!-- Copyright (C) 2018 All rights reserved -->
============================================================================*/

/*----------------------------------------------------------------------------
  @brief
Provide API to convert between ASCII and binary encoded format 
----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------
  include files
----------------------------------------------------------------------------*/
#include "srv__serialise.h"
#include "utils/utils.h"
#include <string.h>
#include <stdint.h>
#include <stdio.h>

/*----------------------------------------------------------------------------
  manifest constants
----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------
  type definitions
----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------
  macros
----------------------------------------------------------------------------*/
#define SRV_SERIALISE_LINE_FORMAT   "%4d%2d%2d_%2d:%2d:%2d:%s:%s\r\n"

/*----------------------------------------------------------------------------
  prototypes
----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------
  global variables
----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------
  static variables
----------------------------------------------------------------------------*/
static data__log_packet_t * srv__serialise_packet_ptr;
/*----------------------------------------------------------------------------
  public functions
----------------------------------------------------------------------------*/

/*============================================================================
@brief
------------------------------------------------------------------------------
@note
============================================================================*/
void srv__serialise_init( data__log_packet_t * packet_ptr )
{
    srv__serialise_packet_ptr = packet_ptr;
    memset( packet_ptr , 0 , data__log_get_packet_len( data__log_type_raw_adc ) );
}

/*============================================================================
@brief
------------------------------------------------------------------------------
@note
============================================================================*/
void srv__serialise_to_bin( char * line_str , int line_size )
{
    int year , month , day;
    int hour , minute , second;
    char type_value[ 32 ] = "";
    char type[ 16 ] = "";
    int tenth , unit;

    sscanf( line_str , SRV_SERIALISE_LINE_FORMAT , & year , & month , & day ,
                                                    & hour , & minute , & second ,
                                                    type_value );
    
    printf( "type_value: %s\r\n"  , type_value );

    srv__serialise_packet_ptr->header.timestamp = utils__convert_caleedar_time_to_epoch( year , month , day , hour , minute , second);
    srv__serialise_packet_ptr->header.log_type = data__log_type_temperature;
    sscanf( type_value , "%[^:]:%2d,%1d\r\n" , type , & unit , & tenth );
    printf( "unit: %d , tenth: %d\r\n"  , unit , tenth );
    if( tenth >= 5) unit++;
    srv__serialise_packet_ptr->temperature_payload.value = unit;
}

/*----------------------------------------------------------------------------
  private functions
----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------
  End of file
----------------------------------------------------------------------------*/
